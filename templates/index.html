<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FACT Spanish Speech Performance Check üçì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --color-primary: #ef7c8e;
            --color-primary-light: #ffe8e3;
            --color-secondary: #e89a8a;
            --color-accent: #db6565;
            --color-teal-dark: #6b8d94;
            --color-teal: #7ba1a5;
            --color-bg-light: #f8ebec;
            --color-text-dark: #333333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg-light);
            margin: 0;
            padding: clamp(10px, 2vh, 20px) 0 clamp(15px, 3vh, 40px);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background-color: white;
            border-radius: 10px;
            padding: clamp(15px, 4vw, 30px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }
        
        .header {
            background-color: var(--color-primary);
            color: white;
            text-align: center;
            margin: clamp(-15px, -4vw, -30px) clamp(-15px, -4vw, -30px) clamp(15px, 3vw, 30px);
            padding: clamp(12px, 2.5vw, 20px) clamp(15px, 4vw, 30px);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .header h1 {
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: clamp(1.1rem, 4vw, 1.6rem);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .header .lead {
            font-size: clamp(0.75rem, 2.5vw, 0.95rem);
            line-height: 1.3;
        }

        .instructions-text {
            font-size: clamp(0.75rem, 2.5vw, 0.85rem);
            color: #6c757d;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .card-header {
            background-color: var(--color-primary-light);
            border-radius: 5px;
        }
        
        .btn-record {
            background-color: var(--color-accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-record.recording {
            animation: pulse 1.5s infinite;
        }
        
        .btn-record:hover {
            background-color: var(--color-secondary);
        }

        .btn-record:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-submit {
            background-color: var(--color-teal-dark);
            color: white;
            border: none;
        }
        
        .btn-submit:hover {
            background-color: var(--color-teal);
        }

        /* Result container - hidden by default, shown after analysis */
        .result-container {
            margin-top: clamp(15px, 3vw, 30px);
            padding: clamp(12px, 3vw, 20px);
            border-radius: 5px;
            background-color: var(--color-bg-light);
            display: none;
        }

        /* Recording section */
        .recording-section {
            display: block;
        }

        .level-display {
            font-size: clamp(16px, 4vw, 20px);
            color: var(--color-teal-dark);
            text-align: center;
            margin-bottom: clamp(10px, 2.5vw, 20px);
        }

        .score-meter {
            min-height: 28px;
            height: auto;
            background-color: #e9ecef;
            border-radius: 15px;
            margin-bottom: clamp(10px, 2.5vw, 20px);
            overflow: hidden;
        }

        .score-fill {
            min-height: 28px;
            background: linear-gradient(90deg, #db6565 0%, #ef7c8e 50%, #7ba1a5 100%);
            border-radius: 15px;
            transition: width 1s;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: clamp(12px, 3vw, 16px);
            padding: 4px 8px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Style for the prompt section */
        .prompt-section {
            background-color: transparent;
            border-radius: 0;
            padding: 0 0 20px 0;
            margin-bottom: 20px;
            text-align: center;
        }

        .prompt-title {
            color: var(--color-text-dark);
            font-weight: 500;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        
        .prompt-links {
            display: flex;
            justify-content: center;
            gap: 8px;
            width: 100%;
            max-width: 100%;
        }

        .prompt-link {
            flex: 1;
            padding: 12px 20px;
            background-color: #f5f5f5;
            color: #666;
            text-decoration: none;
            border: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            cursor: pointer;
        }

        .prompt-link:hover {
            background-color: #e8e8e8;
            color: #555;
            text-decoration: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }

        .prompt-link.active {
            background-color: var(--color-accent);
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(219, 101, 101, 0.3);
        }

        /* Responsive styles for tablets and mobile */
        @media (max-width: 768px) {
            .container {
                margin: 0 10px;
                border-radius: 8px;
            }

            .card-body {
                padding: 15px;
            }

            .result-container .card {
                margin-bottom: 12px;
            }
        }

        @media (max-width: 576px) {
            .prompt-link {
                padding: 8px 10px;
                font-size: 0.9rem;
            }

            .container {
                margin: 0 5px;
                padding: 12px;
            }

            .header {
                margin: -12px -12px 15px;
                padding: 12px 15px;
            }

            .card-header h5 {
                font-size: 1rem;
            }

            .result-container h3 {
                font-size: 1.1rem;
                margin-bottom: 15px;
            }

            footer {
                margin-top: 15px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 400px) {
            .prompt-link {
                padding: 8px 8px;
                font-size: 0.85rem;
            }

            .header h1 {
                font-size: 1rem;
            }

            .header .lead {
                font-size: 0.7rem;
            }

            .score-fill {
                font-size: 11px;
                padding: 3px 5px;
            }
        }

        /* For iframe contexts with limited height */
        @media (max-height: 700px) {
            body {
                padding: 5px 0 10px;
            }

            .container {
                padding: 15px;
            }

            .header {
                margin-bottom: 15px;
                padding: 10px 15px;
            }

            .result-container {
                margin-top: 15px;
                padding: 12px;
            }

            .card.mb-3, .card.mb-4 {
                margin-bottom: 10px !important;
            }

            footer {
                margin-top: 15px;
            }
        }
        
        /* Inline prompt display */
        #promptDisplay {
            background-color: var(--color-primary-light);
            border: none;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        #promptDisplay .card-body {
            padding: 20px;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        footer {
            text-align: center;
            margin-top: clamp(15px, 3vw, 30px);
            color: var(--color-teal-dark);
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .footer-link {
            color: #6c757d;
            font-size: inherit;
        }

        /* Ensure feedback text is readable with high contrast */
        #feedbackText,
        #strengthsList,
        #improvementsList,
        #profileDescription,
        #transcribedText {
            color: #333333; /* Dark gray/black for high contrast and readability */
        }

        #strengthsList li,
        #improvementsList li {
            color: #333333;
        }

        #improvementsList li strong {
            color: #2d5016; /* Dark high-contrast green for emphasized words */
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>FACT Spanish Speech Performance Check üçì</h1>
            <p class="lead mb-0"><em>A snapshot of how clearly and effectively you communicate in spoken Spanish.</em></p>
        </div>

        <!-- Recording Section -->
        <div id="recordingSection" class="recording-section" role="main" aria-label="Speech recording area">
            <div class="card mb-4">
                    <div class="card-body">
                        <!-- Instructions -->
                        <p class="instructions-text">Record a short sample of your spoken Spanish (<strong>15‚Äì60 seconds</strong>) to receive feedback on clarity, communication, and speech flow.</p>

                        <!-- Prompt Section -->
                        <div class="prompt-section">
                            <p class="prompt-title">Need inspiration? Select a level:</p>
                            <div class="prompt-links">
                                <a href="#" class="prompt-link" data-level="beginner">Beginner</a>
                                <a href="#" class="prompt-link" data-level="intermediate">Intermediate</a>
                                <a href="#" class="prompt-link" data-level="advanced">Advanced</a>
                            </div>
                        </div>

                        <!-- Inline Prompt Display -->
                        <div id="promptDisplay" class="card mb-3" style="display: none;">
                            <div class="card-body position-relative">
                                <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Close" id="closePromptDisplay"></button>
                                <p><strong id="promptTopicTitle">Topic: Introduce Yourself</strong></p>
                                <p id="promptInstructions">Speak freely in Spanish.</p>
                                <p style="margin-top: 10px; margin-bottom: 5px;"><strong>Guidance (what to include):</strong></p>
                                <ul id="promptGuidanceBullets" style="margin-bottom: 10px;">
                                    <!-- Bullets added dynamically -->
                                </ul>
                                <p id="promptReminder" style="font-style: italic; color: #666;"></p>
                                <p id="promptDuration"><strong>Time: 15‚Äì60 seconds</strong></p>
                            </div>
                        </div>

                        <div class="text-center">
                            <button id="recordButton" class="btn btn-record" aria-label="Start recording your speech">
                                <i class="bi bi-mic" aria-hidden="true"></i> Start Recording
                            </button>
                            <p id="recordingStatus" class="mt-2" role="status" aria-live="polite"></p>
                            <div id="recordingTimer" class="mt-2" style="display: none;">00:00</div>
                        </div>
                        <div id="audioPreview" class="mt-3" style="display: none;">
                            <h6>Preview:</h6>
                            <audio id="recordedAudio" controls class="w-100"></audio>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button id="submitButton" class="btn btn-submit" disabled aria-label="Submit audio for pronunciation analysis">Analyze Pronunciation</button>
                </div>

            <div id="loadingIndicator" class="text-center my-4" role="status" aria-live="assertive" aria-label="Processing audio" style="display: none;">
                <div class="spinner-border text-primary" aria-hidden="true">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Analyzing your pronunciation... Please wait.</p>
            </div>
        </div>

        <!-- Results Section - Hidden by default -->
        <div id="resultContainer" class="result-container" role="region" aria-label="Assessment results" aria-live="polite">
                <h3 class="text-center mb-4">Pronunciation Snapshot</h3>
                <div id="scoreContainer">
                    <div class="level-display"><span id="profileDescription"></span></div>
                    <div class="score-meter">
                        <div class="score-fill" id="scoreFill" style="width: 0%;">Estimated Clarity: 0%</div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">What We Heard</h5>
                    </div>
                    <div class="card-body">
                        <p id="transcribedText" class="mb-0"></p>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Feedback</h5>
                    </div>
                    <div class="card-body">
                        <p id="feedbackText" class="mb-2"></p>

                        <h6 class="mt-4">Strengths:</h6>
                        <ul id="strengthsList"></ul>

                        <h6 class="mt-3">Where to Focus Next:</h6>
                        <ul id="improvementsList"></ul>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5 class="mb-0">Automated Pronunciation Example</h5>
                    </div>
                    <div class="card-body">
                        <audio id="ttsAudio" controls class="w-100">
                            <source src="" type="audio/mp3">
                            Your browser does not support audio playback.
                        </audio>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button id="newRecordingButton" class="btn btn-submit" aria-label="Start a new speech assessment">Start New Assessment</button>
                </div>
            </div>
    </div>

    <footer class="mt-4">
        <p>¬© 2025 Spanish Learning Edge LLC</p>
        <p><a href="/static/How_This_Evaluation_Works.pdf" target="_blank" class="footer-link">How This Evaluation Works</a></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const recordButton = document.getElementById('recordButton');
            const submitButton = document.getElementById('submitButton');
            const recordingStatus = document.getElementById('recordingStatus');
            const recordingTimer = document.getElementById('recordingTimer');
            const profileDescription = document.getElementById('profileDescription');
            const scoreFill = document.getElementById('scoreFill');
            const transcribedText = document.getElementById('transcribedText');
            const ttsAudio = document.getElementById('ttsAudio');
            const feedbackText = document.getElementById('feedbackText');
            const strengthsList = document.getElementById('strengthsList');
            const improvementsList = document.getElementById('improvementsList');
            const newRecordingButton = document.getElementById('newRecordingButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const audioPreview = document.getElementById('audioPreview');
            const recordedAudio = document.getElementById('recordedAudio');

            // View switching elements
            const recordingSection = document.getElementById('recordingSection');
            const resultContainer = document.getElementById('resultContainer');

            // Function to switch between views using simple display toggle
            function switchToView(viewName) {
                if (viewName === 'results') {
                    recordingSection.style.display = 'none';
                    resultContainer.style.display = 'block';
                } else {
                    resultContainer.style.display = 'none';
                    recordingSection.style.display = 'block';
                }
            }

            // Safe HTML rendering - only allows <strong> tags for emphasis
            function createSafeListItem(htmlContent) {
                const li = document.createElement('li');
                // Parse the content and only allow <strong> tags
                const parts = htmlContent.split(/(<strong>|<\/strong>)/i);
                let inStrong = false;
                let currentSpan = null;

                parts.forEach(part => {
                    if (part.toLowerCase() === '<strong>') {
                        inStrong = true;
                        currentSpan = document.createElement('strong');
                    } else if (part.toLowerCase() === '</strong>') {
                        if (currentSpan) {
                            li.appendChild(currentSpan);
                            currentSpan = null;
                        }
                        inStrong = false;
                    } else if (part) {
                        // Add text content (safely escaped)
                        const textNode = document.createTextNode(part);
                        if (inStrong && currentSpan) {
                            currentSpan.appendChild(textNode);
                        } else {
                            li.appendChild(textNode);
                        }
                    }
                });

                // Handle unclosed strong tag
                if (currentSpan) {
                    li.appendChild(currentSpan);
                }

                return li;
            }
            
            // PromptRenderer - Single component parameterized by level
            // Per CAPA 1 spec: prompts provide guidance bullets, NOT fixed scripts
            const promptData = {
                beginner: {
                    level: "Beginner (B√°sico)",
                    topic: "Topic: Pres√©ntate / Introduce Yourself",
                    instructions: "Speak about yourself in Spanish. Use simple, complete sentences in the present tense.",
                    guidanceBullets: [
                        "Your name and where you are from",
                        "Your age and what you do (student, job, etc.)",
                        "What languages you speak",
                        "One or two hobbies or interests"
                    ],
                    reminder: "Speak calmly and clearly. Do not read from a written text‚Äîyou may use brief notes.",
                    duration: "Time: 15-60 seconds"
                },
                intermediate: {
                    level: "Intermediate (Intermedio)",
                    topic: "Topic: Describe tu d√≠a (ayer) / Describe Your Day (Yesterday)",
                    instructions: "Describe what you did yesterday in Spanish. Speak in the past tense and organize your ideas in order.",
                    guidanceBullets: [
                        "What time you woke up and what you did in the morning",
                        "Two or three activities you did during the day",
                        "If you talked with or met other people",
                        "How you felt at some point in the day"
                    ],
                    reminder: "Use simple connectors to organize your story (primero, despu√©s, por la tarde). Speak continuously‚Äîdo not respond as a list.",
                    duration: "Time: 20-60 seconds"
                },
                advanced: {
                    level: "Advanced (Avanzado)",
                    topic: "Topic: Tecnolog√≠a y educaci√≥n / Technology and Education",
                    instructions: "Express your opinion about how technology influences education today. Speak in an organized, reflective, and personal way.",
                    guidanceBullets: [
                        "Something you find positive or important about technology in education",
                        "Something that worries you, bothers you, or makes you uncertain",
                        "A personal experience with digital platforms or tools",
                        "An idea about what should change or improve in the future of education"
                    ],
                    reminder: "Try to express emotions, evaluations, or personal opinions using expressions like: me parece importante que..., me preocupa que..., es necesario que..., no creo que..., aunque..., para que... Use connectors to organize your speech (por un lado..., por otro..., sin embargo, aunque...). Speak fluently‚Äîdo not memorize a text.",
                    duration: "Time: 30-60 seconds"
                }
            };

            // Prompt display handling
            const promptDisplay = document.getElementById('promptDisplay');
            const promptTopicTitle = document.getElementById('promptTopicTitle');
            const promptInstructions = document.getElementById('promptInstructions');
            const promptGuidanceBullets = document.getElementById('promptGuidanceBullets');
            const promptReminder = document.getElementById('promptReminder');
            const promptDuration = document.getElementById('promptDuration');
            const closePromptDisplay = document.getElementById('closePromptDisplay');
            const promptLinks = document.querySelectorAll('.prompt-link');

            // Show prompt when a level is clicked
            promptLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const level = this.getAttribute('data-level');

                    if (promptData[level]) {
                        const data = promptData[level];

                        // Store selected level for assessment
                        selectedLevel = level;

                        // Remove active class from all links
                        promptLinks.forEach(l => l.classList.remove('active'));
                        // Add active class to clicked link
                        this.classList.add('active');

                        // Set content per CAPA 1 spec
                        promptTopicTitle.textContent = data.topic;
                        promptInstructions.textContent = data.instructions;

                        // Build guidance bullets
                        promptGuidanceBullets.innerHTML = '';
                        data.guidanceBullets.forEach(bullet => {
                            const li = document.createElement('li');
                            li.textContent = bullet;
                            promptGuidanceBullets.appendChild(li);
                        });

                        promptReminder.textContent = data.reminder;
                        promptDuration.innerHTML = '<strong>' + data.duration + '</strong>';

                        // Show the display
                        promptDisplay.style.display = 'block';

                        // Smooth scroll to prompt section after it becomes visible
                        setTimeout(() => {
                            promptDisplay.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                });
            });

            // Close prompt display
            closePromptDisplay.addEventListener('click', function() {
                promptDisplay.style.display = 'none';
                // Remove active class from all links when closing
                promptLinks.forEach(l => l.classList.remove('active'));
            });

            let mediaRecorder;
            let audioChunks = [];
            let recording = false;
            let recordingTime = 0;
            let timerInterval;
            let audioURL = null;
            let selectedAudioFile = null;
            let selectedLevel = 'intermediate'; // Track selected level (default: intermediate)

            // Capture URL parameters for tracking
            const urlParams = new URLSearchParams(window.location.search);
            const trackingSource = urlParams.get('source') || 'direct';
            const trackingCohort = urlParams.get('cohort') || 'none';

            // Recording
            recordButton.addEventListener('click', () => {
                if (!recording) {
                    startRecording();
                } else {
                    stopRecording();
                }
            });
            
            async function startRecording() {
                try {
                    recordingStatus.textContent = '';
                    audioPreview.style.display = 'none';
                    submitButton.disabled = true;
                    selectedAudioFile = null;

                    // iOS-compatible audio constraints
                    const audioConstraints = {
                        audio: {
                            channelCount: 1,
                            sampleRate: 48000,
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    const stream = await navigator.mediaDevices.getUserMedia(audioConstraints);

                    // Detect supported MIME type for iOS compatibility
                    let mimeType = 'audio/webm';
                    let fileExtension = 'webm';

                    if (MediaRecorder.isTypeSupported('audio/webm')) {
                        mimeType = 'audio/webm';
                        fileExtension = 'webm';
                    } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                        mimeType = 'audio/mp4';
                        fileExtension = 'mp4';
                    } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                        mimeType = 'audio/wav';
                        fileExtension = 'wav';
                    }

                    // Create MediaRecorder with detected MIME type and explicit bitrate
                    // Use 32 kbps bitrate to ensure predictable file sizes and compatibility
                    // with inline transcription (keeps 60s recordings under 240 KB)
                    const recorderOptions = {
                        mimeType: mimeType,
                        audioBitsPerSecond: 32000  // 32 kbps for speech
                    };

                    mediaRecorder = new MediaRecorder(stream, recorderOptions);
                    audioChunks = [];

                    mediaRecorder.addEventListener('dataavailable', e => {
                        if (e.data.size > 0) {
                            audioChunks.push(e.data);
                        }
                    });

                    mediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        selectedAudioFile = new File([audioBlob], `recording.${fileExtension}`, { type: mimeType });

                        if (audioURL) {
                            URL.revokeObjectURL(audioURL);
                        }
                        audioURL = URL.createObjectURL(audioBlob);

                        // Detect iOS devices
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

                        if (isIOS) {
                            // On iOS, show success message instead of audio player
                            audioPreview.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> Recording saved successfully!
                                    <br>File size: ${(audioBlob.size / 1024).toFixed(2)} KB
                                    <br>Analyzing pronunciation...
                                </div>
                            `;
                            audioPreview.style.display = 'block';
                        } else {
                            // On desktop, show audio preview as normal
                            audioPreview.innerHTML = `
                                <h6>Preview:</h6>
                                <audio id="recordedAudio" controls class="w-100"></audio>
                            `;
                            const audioElement = audioPreview.querySelector('#recordedAudio');
                            audioElement.src = audioURL;
                            audioPreview.style.display = 'block';
                        }

                        submitButton.disabled = false;

                        // Auto-trigger analysis after recording stops
                        setTimeout(() => {
                            submitButton.click();
                        }, 500);
                    });

                    // Use timeslice for iOS compatibility
                    mediaRecorder.start(1000);
                    recording = true;

                    // Reset record button
                    recordButton.innerHTML = '<i class="bi bi-stop-fill"></i> Stop Recording';
                    recordButton.classList.add('recording');

                    recordingStatus.textContent = 'Recording...';
                    audioPreview.style.display = 'none';
                    recordingTime = 0;
                    recordingTimer.style.display = 'block';
                    timerInterval = setInterval(updateTimer, 1000);

                    // 90 second limit
                    setTimeout(() => {
                        if (recording) {
                            stopRecording();
                            recordingStatus.textContent = '90-second limit reached.';
                        }
                    }, 90 * 1000);
                } catch (err) {
                    console.error('Microphone error:', err);
                    recordingStatus.textContent = 'Error accessing microphone. Check permissions.';
                }
            }
            
            function stopRecording() {
                if (mediaRecorder && recording) {
                    mediaRecorder.stop();
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    recording = false;
                    
                    // Reset record button
                    recordButton.innerHTML = '<i class="bi bi-mic"></i> Start Recording';
                    recordButton.classList.remove('recording');
                    
                    recordingStatus.textContent = 'Recording stopped.';
                    clearInterval(timerInterval);
                    recordingTimer.style.display = 'none';
                }
            }
            
            function updateTimer() {
                recordingTime++;
                const minutes = Math.floor(recordingTime / 60).toString().padStart(2, '0');
                const seconds = (recordingTime % 60).toString().padStart(2, '0');
                recordingTimer.textContent = `${minutes}:${seconds}`;
            }

            // Submit
            submitButton.addEventListener('click', () => {
                if (!selectedAudioFile) {
                    alert('Please record an audio first.');
                    return;
                }

                // Validate minimum audio length (roughly 10 seconds at 32 kbps = ~40KB)
                const minSizeBytes = 40 * 1024;
                if (selectedAudioFile.size < minSizeBytes) {
                    alert('Please record at least 15 seconds of audio for accurate assessment.');
                    return;
                }

                // Validate maximum audio file size (10MB limit for API)
                const maxSizeBytes = 10 * 1024 * 1024;
                if (selectedAudioFile.size > maxSizeBytes) {
                    alert('Audio file is too large. Please record a shorter sample (under 90 seconds).');
                    return;
                }

                loadingIndicator.style.display = 'block';

                const formData = new FormData();
                formData.append('file', selectedAudioFile);
                formData.append('level', selectedLevel); // Send selected level to backend
                formData.append('source', trackingSource); // Send tracking source
                formData.append('cohort', trackingCohort); // Send tracking cohort

                fetch('/process-audio', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    // Check for HTTP errors before parsing JSON
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    if (data.error) {
                        // Reset UI state to allow retry
                        submitButton.disabled = false;
                        alert('Error: ' + data.error);
                        return;
                    }

                    // The profile description is already included in the feedback text from backend
                    // No need to display it separately - the backend now sends the correct profile-based feedback
                    profileDescription.textContent = '';

                    scoreFill.style.width = data.score + '%';
                    scoreFill.textContent = 'Estimated Clarity: ' + Math.round(data.score) + '%';

                    // Show transcription
                    transcribedText.textContent = data.transcribed_text;

                    // Set feedback text
                    feedbackText.textContent = data.feedback;

                    // TTS feedback audio
                    if (data.tts_audio_url) {
                        ttsAudio.src = data.tts_audio_url;
                    }

                    // Strengths
                    strengthsList.innerHTML = '';
                    data.strengths.forEach(strength => {
                        const li = document.createElement('li');
                        li.textContent = strength;
                        strengthsList.appendChild(li);
                    });

                    // Areas for improvement - use safe HTML rendering
                    improvementsList.innerHTML = '';
                    data.areas_for_improvement.forEach(area => {
                        const li = createSafeListItem(area);
                        improvementsList.appendChild(li);
                    });

                    // Switch to results view with transition
                    switchToView('results');

                    // Smooth scroll to results section after it becomes visible
                    setTimeout(() => {
                        resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);

                    // Disable Start Recording button until Start New Assessment is clicked
                    recordButton.disabled = true;
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    // Reset UI state to allow retry
                    submitButton.disabled = false;
                    console.error('Audio processing error:', error);

                    // Provide user-friendly error message
                    let userMessage = 'An error occurred while processing your audio. ';
                    if (error.message.includes('Server error')) {
                        userMessage += 'The server encountered a problem. Please try again in a moment.';
                    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                        userMessage += 'Please check your internet connection and try again.';
                    } else {
                        userMessage += 'Please try recording again.';
                    }
                    alert(userMessage);
                });
            });

            // New recording - switch back to record view
            newRecordingButton.addEventListener('click', () => {
                switchToView('record');
                audioPreview.style.display = 'none';
                recordingStatus.textContent = '';
                submitButton.disabled = true;
                recordButton.disabled = false;  // Re-enable Start Recording button
                selectedAudioFile = null;
                if (audioURL) {
                    URL.revokeObjectURL(audioURL);
                    audioURL = null;
                }
            });
        });
    </script>
</body>
</html>
